---
const { lang } = Astro.props;
import Logo from '../ui/Logo.astro';

const navItems = {
  nl: [
    { name: 'Home', href: '/nl' },
    { 
      name: 'Accommodatie', 
      href: '/nl/accommodatie',
      children: [
        { name: 'De Oude Schuur', href: '/nl/accommodatie/de-oude-schuur' },
        { name: 'De Peerdestal', href: '/nl/accommodatie/de-peerdestal' }
      ]
    },
    { name: 'Omgeving', href: '/nl/omgeving' },
    { name: 'Gallerij', href: '/nl/gallerij' },
    { name: 'Contact', href: '/nl/contact' },
  ],
  en: [
    { name: 'Home', href: '/en' },
    { 
      name: 'Accommodation', 
      href: '/en/accommodatie',
      children: [
        { name: 'The Old Barn', href: '/en/accommodatie/de-oude-schuur' },
        { name: 'The Horse Stable', href: '/en/accommodatie/de-peerdestal' }
      ]
    },
    { name: 'Surroundings', href: '/en/omgeving' },
    { name: 'Gallery', href: '/en/gallerij' },
    { name: 'Contact', href: '/en/contact' },
  ],
  de: [
    { name: 'Start', href: '/de' },
    { 
      name: 'Unterkunft', 
      href: '/de/accommodatie',
      children: [
        { name: 'Die Alte Scheune', href: '/de/accommodatie/de-oude-schuur' },
        { name: 'Der Pferdestall', href: '/de/accommodatie/de-peerdestal' }
      ]
    },
    { name: 'Umgebung', href: '/de/omgeving' },
    { name: 'Galerie', href: '/de/gallerij' },
    { name: 'Kontakt', href: '/de/contact' },
  ]
};

const currentNav = navItems[lang] || navItems.nl;
---

<nav class="bg-foam-white/90 backdrop-blur-md shadow-sm fixed w-full z-50 transition-all duration-300 border-b border-dune-sand/30">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-20 items-center">
      <div class="flex-shrink-0 flex items-center z-50">
        <Logo class="text-bordeaux hover:text-bordeaux-dark transition-colors" />
      </div>
      
      <!-- Desktop Menu -->
      <div class="hidden md:ml-6 md:flex md:space-x-8 items-center">
        {currentNav.map((item) => (
          <div class="relative group">
            <a
              href={item.href}
              class="text-slate-600 hover:text-bordeaux px-3 py-2 text-sm font-bold transition-colors duration-200 relative inline-flex items-center gap-1"
            >
              {item.name}
              {item.children && (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mt-0.5 group-hover:rotate-180 transition-transform duration-200">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
              )}
              <span class="absolute bottom-0 left-0 w-full h-0.5 bg-dune-sand transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></span>
            </a>
            
            {item.children && (
              <div class="absolute left-0 mt-0 w-48 bg-white rounded-b-sm shadow-lg py-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-left -translate-y-2 group-hover:translate-y-0 z-50 border-t-2 border-bordeaux">
                {item.children.map((child) => (
                  <a
                    href={child.href}
                    class="block px-4 py-3 text-sm text-slate-600 hover:bg-foam-white hover:text-bordeaux transition-colors"
                  >
                    {child.name}
                  </a>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
      
      <!-- Desktop Language Selector -->
      <div class="hidden md:flex items-center space-x-4">
        <a href="/nl" class={`text-sm font-semibold transition-colors ${lang === 'nl' ? 'text-bordeaux' : 'text-slate-400 hover:text-bordeaux'}`}>NL</a>
        <span class="text-dune-sand">|</span>
        <a href="/en" class={`text-sm font-semibold transition-colors ${lang === 'en' ? 'text-bordeaux' : 'text-slate-400 hover:text-bordeaux'}`}>EN</a>
        <span class="text-dune-sand">|</span>
        <a href="/de" class={`text-sm font-semibold transition-colors ${lang === 'de' ? 'text-bordeaux' : 'text-slate-400 hover:text-bordeaux'}`}>DE</a>
      </div>

      <!-- Mobile Menu Button -->
      <div class="flex items-center md:hidden z-50">
        <button 
          id="mobile-menu-btn"
          type="button" 
          class="text-bordeaux hover:text-bordeaux-dark p-2 focus:outline-none" 
          aria-label="Menu"
        >
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </div>

</nav>

<!-- Mobile Menu Overlay -->
<div 
  id="mobile-menu"
  class="fixed inset-0 bg-stone-50 z-[60] transform translate-x-full transition-transform duration-300 ease-in-out md:hidden flex flex-col"
>
  <!-- Header with Logo and Close Button -->
  <div class="flex justify-between items-center p-6 border-b border-dune-sand/10">
      <div>
        <Logo class="text-bordeaux" />
      </div>
      <button 
        id="close-menu-btn"
        type="button" 
        class="text-bordeaux hover:text-bordeaux-dark p-2 focus:outline-none bg-foam-white rounded-full shadow-sm"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
  </div>

  <!-- Mobile Nav Links -->
  <div class="flex-grow overflow-y-auto py-8 px-6">
    <div class="flex flex-col space-y-2">
      {currentNav.map((item) => (
        <div class="border-b border-dune-sand/10 last:border-0 pb-2">
          {item.children ? (
             <div>
                <button 
                  class="accordion-trigger flex justify-between items-center w-full py-3 text-left group"
                >
                  <span class="text-2xl font-heading font-light text-slate-800 group-hover:text-bordeaux transition-colors">{item.name}</span>
                  <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    fill="none" 
                    viewBox="0 0 24 24" 
                    stroke-width="1.5" 
                    stroke="currentColor" 
                    class="accordion-icon w-6 h-6 text-slate-400 transition-transform duration-300"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                  </svg>
                </button>
                
                <div class="hidden pl-4 pb-2 space-y-3">
                   {item.children.map((child) => (
                     <a
                       href={child.href}
                       class="block text-lg font-heading font-light text-slate-500 hover:text-bordeaux py-2 border-l-2 border-transparent hover:border-bordeaux pl-3 transition-all"
                     >
                       {child.name}
                     </a>
                   ))}
                </div>
             </div>
          ) : (
            <a
              href={item.href}
              class="block py-3 text-2xl font-heading font-light text-slate-800 hover:text-bordeaux transition-colors"
            >
              {item.name}
            </a>
          )}
        </div>
      ))}
    </div>
  </div>

  <!-- Mobile Language Selector & Footer Info -->
  <div class="p-8 border-t border-dune-sand/10 bg-white">
      <div class="flex items-center space-x-6 mb-8">
          <a href="/nl" class={`text-lg font-bold transition-colors ${lang === 'nl' ? 'text-bordeaux underline underline-offset-4' : 'text-slate-400'}`}>NL</a>
          <a href="/en" class={`text-lg font-bold transition-colors ${lang === 'en' ? 'text-bordeaux underline underline-offset-4' : 'text-slate-400'}`}>EN</a>
          <a href="/de" class={`text-lg font-bold transition-colors ${lang === 'de' ? 'text-bordeaux underline underline-offset-4' : 'text-slate-400'}`}>DE</a>
      </div>
      <p class="text-xs text-slate-400 font-light">
          Boerderij Voorste Eng<br>
          Edeseweg 2, Otterlo
      </p>
  </div>
</div>

  function setupMobileMenu() {
    const menuBtn = document.getElementById('mobile-menu-btn');
    const closeBtn = document.getElementById('close-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuLinks = mobileMenu?.querySelectorAll('a');

    // Remove existing listeners to be safe
    const newMenuBtn = menuBtn?.cloneNode(true);
    const newCloseBtn = closeBtn?.cloneNode(true);
    
    // Replace old buttons to clear listeners
    if (menuBtn && newMenuBtn) menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
    if (closeBtn && newCloseBtn) closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

    const activeMenuBtn = document.getElementById('mobile-menu-btn');
    const activeCloseBtn = document.getElementById('close-menu-btn');

    function toggleMenu() {
      if (mobileMenu) {
          mobileMenu.classList.toggle('translate-x-full');
          document.body.classList.toggle('overflow-hidden');
      }
    }

    activeMenuBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
    });
    
    activeCloseBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
    });

    // Submenu Accordion Logic (Vanilla JS replacement for Alpine)
    const accordionTriggers = mobileMenu?.querySelectorAll('.accordion-trigger');
    
    accordionTriggers?.forEach(trigger => {
        // Clone to remove old listeners if any
        const newTrigger = trigger.cloneNode(true);
        trigger.parentNode.replaceChild(newTrigger, trigger);
    });

    // Re-select after cloning
    const freshTriggers = mobileMenu?.querySelectorAll('.accordion-trigger');

    freshTriggers?.forEach(trigger => {
        trigger.addEventListener('click', (e) => {
            const content = trigger.nextElementSibling;
            const icon = trigger.querySelector('.accordion-icon');
            
            // Toggle visibility
            content.classList.toggle('hidden');
            
            // Toggle icon rotation
            if (content.classList.contains('hidden')) {
                icon.classList.remove('rotate-180', 'text-bordeaux');
            } else {
                icon.classList.add('rotate-180', 'text-bordeaux');
            }
        });
    });

    // Close menu when a link is clicked
    menuLinks?.forEach(link => {
      link.addEventListener('click', () => {
          if (mobileMenu && !mobileMenu.classList.contains('translate-x-full')) {
              toggleMenu();
          }
      });
    });
  }

  // Run on initial load and view transitions
  document.addEventListener('astro:page-load', setupMobileMenu);
</script>

<div class="h-20"></div> <!-- Spacer -->
